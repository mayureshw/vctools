:-import load/2, store/3 from fileio.

:-dynamic dpdep/3, dpe/4.

:-index(dpe/4,[1,3]).
:-op(500,xfx,^).
:-op(700,xfx,->).

sdep( de(N,req0) ^ de(N,req1) -> de(N,ack0), 'Phi req0^req1 -> ack0'    ) :- dpe(_,N,'vcPhiPipelined',_).

sdep( de(N,req0) -> de(N,ack0) ^ de(N,ack1), 'Branch req0 -> ack0^ack1' ) :- dpe(_,N,'vcBranch',_).

sdep( Dep, Msg ) :- splitop(SO), \+ isFlowThrough(SO), dpe(SO,N,_,_),
    (
      ( Dep = ( de(N,req0) -> de(N,ack0) ), Msg = 'SplitOp req0 -> ack0' );
      ( Dep = ( de(N,req0) -> de(N,ack1) ), Msg = 'SplitOp req0 -> ack1' );
      ( Dep = ( de(N,req1) -> de(N,ack1) ), Msg = 'SplitOp req1 -> ack1' )
    ).

sdep( Dep, Msg ) :- splitop(UID), \+ isFlowThrough(SO), dpdep(UID,_,DID), splitop(DID), dpe(UID,U,_,_), dpe(DID,D,_,_),
    (
      ( Dep = ( de(D,ack1) -> de(U,req0) ), Msg = 'Use-Def Def-ack1 -> Use-req0');
      ( Dep = ( de(D,req1) -> de(U,ack0) ), Msg = 'Use-Def Def-req1 -> Use-ack0')
    ).

splitop(O) :- dpe(O,_,'vcBinarySplitOperator',_).

:-table isFlowThrough/1.
isFlowThrough(Did) :- vctid(Did,ftreq,_).

depgen(Vc):- load(vcir,Vc), store(iprops,Vc,sdep(_,_)).
